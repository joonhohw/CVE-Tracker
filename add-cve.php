<?php
	include("includes/a_config.php");

	$name = "";
	$attackerkb_id = "";
	$date_added = "";
	$last_updated = "";
	$attacker_value = "";
	$exploitability = "";

	$stmt = $db->prepare("INSERT INTO watchlist (name, attackerkb_id, date_added, last_updated, attacker_value, exploitability) VALUES (?, ?, ?, ?, ?, ?)");
	$stmt->bind_param("ssssss", $name, $attackerkb_id, $date_added, $last_updated, $attacker_value, $exploitability);

	if(isset($_POST['submit']))
	{
		$name = $_POST['name'];
		
		$data = array('name' => $name, 'page' => '0', 'size' => '5');
		$response = CallAPI("https://api.attackerkb.com/v1/topics", $data);
		$response = json_decode($response, TRUE);

		if(strpos($response['data']['0']['name'], $name) !== false) {
			$attackerkb_id = $response['data']['0']['id'];
		} else {
			exit("Please debug 0");
		}

		$response = CallAPI("https://api.attackerkb.com/v1/topics/" . $attackerkb_id);
		$response = json_decode($response, TRUE);
		
		$date_added = date('Y-m-d');
		$last_updated = substr($response['data']['revisionDate'], 0, 10);
		$attacker_value = $response['data']['score']['attackerValue'];
		$exploitability = $response['data']['score']['exploitability'];
	}

	$stmt->execute();
	$stmt->close();

	header("Location: index.php");
	exit();

?>