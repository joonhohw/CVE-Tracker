<?php
	include("includes/a_config.php");

	$records = mysqli_query($db, "select * from watchlist");

	while($data = mysqli_fetch_array($records))
	{
		$id = $data['id'];
		$response = CallAPI("https://api.attackerkb.com/v1/topics/" . $data['attackerkb_id']);
		$response = json_decode($response, TRUE);

		$last_updated = substr($response['data']['revisionDate'], 0, 10);
		$attacker_value = $response['data']['score']['attackerValue'];
		$exploitability = $response['data']['score']['exploitability'];

		if($last_updated != $data['last_updated'] or $attacker_value != $data['attacker_value'] or $exploitability != $data['exploitability'])
		{
			$stmt = $db -> prepare("UPDATE watchlist SET last_updated = ?, attacker_value = ?, exploitability = ? WHERE id = ?");
			$stmt->bind_param("ssss", $last_updated, $attacker_value, $exploitability, $id);

			$stmt->execute();
			$stmt->close();
		}
	}

	header("Location: index.php");
	exit();
?>